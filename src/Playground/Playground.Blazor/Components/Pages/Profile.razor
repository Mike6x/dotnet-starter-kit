@page "/profile"
@inherits ComponentBase
<MudContainer Class="fsh-section">
    <MudGrid>
        <MudItem xs="12" sm="4">
            <MudPaper Class="fsh-card pa-4">
                <MudAvatar Class="fsh-avatar mb-2" Size="Size.Large">
                    <MudImage Src="@_profile.ImageUrl" Alt="@_profile.FirstName" />
                </MudAvatar>
                <label for="profile-upload">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary">Upload Image</MudButton>
                </label>
                <InputFile id="profile-upload" OnChange="OnFileSelected" />
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="8">
            <MudPaper Class="fsh-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Profile</MudText>
                <MudForm @ref="_form" Model="@_profile" OnValidSubmit="SaveProfile">
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_profile.FirstName" Label="First Name" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_profile.LastName" Label="Last Name" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_profile.Email" Label="Email" Disabled="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_profile.PhoneNumber" Label="Phone" />
                        </MudItem>
                    </MudGrid>
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mt-3" ButtonType="ButtonType.Submit">Save</MudButton>
                </MudForm>
            </MudPaper>
            <MudPaper Class="fsh-card pa-4 mt-4">
                <MudText Typo="Typo.h6" Class="mb-3">Change Password</MudText>
                <MudForm @ref="_passwordForm" OnValidSubmit="ChangePassword">
                    <MudTextField @bind-Value="_passwordModel.CurrentPassword" Label="Current Password" InputType="InputType.Password" Required="true" />
                    <MudTextField @bind-Value="_passwordModel.NewPassword" Label="New Password" InputType="InputType.Password" Required="true" />
                    <MudTextField @bind-Value="_passwordModel.ConfirmPassword" Label="Confirm Password" InputType="InputType.Password" Required="true" />
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mt-3" ButtonType="ButtonType.Submit">Update Password</MudButton>
                </MudForm>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private MudForm? _form;
    private MudForm? _passwordForm;
    private ProfileModel _profile = new();
    private PasswordDto _passwordModel = new();
    [Inject] private FSH.Playground.Blazor.ApiClient.IIdentityClient IdentityClient { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var response = await IdentityClient.ProfileGetAsync();
        if (response is not null)
        {
            _profile = new ProfileModel
            {
                Id = response.Id ?? string.Empty,
                FirstName = response.FirstName,
                LastName = response.LastName,
                Email = response.Email,
                PhoneNumber = response.PhoneNumber,
                ImageUrl = response.ImageUrl
            };
        }
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null) return;
        if (file.Size > 1_000_000)
        {
            Snackbar.Add("Image too large. Max 1 MB.", Severity.Error);
            return;
        }
        if (!file.ContentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase))
        {
            Snackbar.Add("Only image uploads are allowed.", Severity.Error);
            return;
        }

        try
        {
            using var stream = file.OpenReadStream(1_000_000);
            using var memory = new MemoryStream();
            await stream.CopyToAsync(memory);
            var bytes = memory.ToArray().Select(b => (int)b).ToList();

            if (string.IsNullOrWhiteSpace(_profile.Id) || string.IsNullOrWhiteSpace(_profile.Email))
            {
                Snackbar.Add("Profile not loaded yet.", Severity.Error);
                return;
            }

            var update = new FSH.Playground.Blazor.ApiClient.UpdateUserCommand
            {
                Id = _profile.Id,
                FirstName = _profile.FirstName ?? string.Empty,
                LastName = _profile.LastName ?? string.Empty,
                PhoneNumber = _profile.PhoneNumber ?? string.Empty,
                Email = _profile.Email,
                Image = new FSH.Playground.Blazor.ApiClient.FileUploadRequest
                {
                    FileName = file.Name,
                    ContentType = file.ContentType,
                    Data = bytes
                },
                DeleteCurrentImage = false
            };

            await IdentityClient.ProfilePutAsync(update);
            await ReloadProfile();
            Snackbar.Add("Profile image updated.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to upload image: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveProfile()
    {
        if (string.IsNullOrWhiteSpace(_profile.Id) || string.IsNullOrWhiteSpace(_profile.Email))
        {
            Snackbar.Add("Profile not loaded yet.", Severity.Error);
            return;
        }

        var request = new FSH.Playground.Blazor.ApiClient.UpdateUserCommand
        {
            Id = _profile.Id,
            FirstName = _profile.FirstName ?? string.Empty,
            LastName = _profile.LastName ?? string.Empty,
            PhoneNumber = _profile.PhoneNumber ?? string.Empty,
            Email = _profile.Email,
            DeleteCurrentImage = false
        };

        try
        {
            await IdentityClient.ProfilePutAsync(request);
            await ReloadProfile();
            Snackbar.Add("Profile updated.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update profile: {ex.Message}", Severity.Error);
        }
    }

    private async Task ChangePassword()
    {
        var req = new FSH.Playground.Blazor.ApiClient.ChangePasswordCommand
        {
            Password = _passwordModel.CurrentPassword ?? string.Empty,
            NewPassword = _passwordModel.NewPassword ?? string.Empty,
            ConfirmNewPassword = _passwordModel.ConfirmPassword ?? string.Empty
        };

        try
        {
            await IdentityClient.ChangePasswordAsync(req);
            Snackbar.Add("Password updated.", Severity.Success);
            _passwordModel = new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update password: {ex.Message}", Severity.Error);
        }
    }

    private async Task ReloadProfile()
    {
        var response = await IdentityClient.ProfileGetAsync();
        _profile = response is null
            ? new ProfileModel()
            : new ProfileModel
            {
                Id = response.Id ?? string.Empty,
                FirstName = response.FirstName,
                LastName = response.LastName,
                Email = response.Email,
                PhoneNumber = response.PhoneNumber,
                ImageUrl = response.ImageUrl
            };
    }

    private sealed class ProfileModel
    {
        public string Id { get; set; } = string.Empty;
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
        public string? Email { get; set; }
        public string? PhoneNumber { get; set; }
        public string? ImageUrl { get; set; }
    }

    private sealed class PasswordDto
    {
        public string? CurrentPassword { get; set; }
        public string? NewPassword { get; set; }
        public string? ConfirmPassword { get; set; }
    }
}
